&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	 УправлениеФормой();
КонецПроцедуры

&НаКлиенте
Процедура УправлениеФормой()
	СертификатЗаполнен = Не Объект.Сертификат.Пустая();
	Элементы.Сертификат.Видимость = СертификатЗаполнен;
	Элементы.ГруппаПериодДействияСертификата.Видимость = СертификатЗаполнен;
	Элементы.НадписьСертификатОтсутствует.Видимость = Не СертификатЗаполнен;
КонецПроцедуры

&НаСервереБезКонтекста
Функция СрокОсвобожденияОтПрививкиПриИзмененииНаСервере(СтруктураПараметров)
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Сотрудник", СтруктураПараметров.Сотрудник);
	Запрос.УстановитьПараметр("ДатаОсвобожденияОтПрививки", СтруктураПараметров.ДатаОсвобождения);
	Запрос.Текст = "ВЫБРАТЬ
	|	докСертификат.Ссылка КАК Сертификат,
	|	докСертификат.НачалоДействияСертификата КАК НачалоДействияСертификата,
	|	докСертификат.КонецДействияСертификата КАК КонецДействияСертификата,
	|	докСертификат.СертификатДействителен КАК СертификатДействителен
	|ИЗ
	|	Документ.COV_СертификатОВакцинацииОтCOVID КАК докСертификат
	|ГДЕ
	|	докСертификат.Сотрудник = &Сотрудник
	|	И НЕ докСертификат.ПометкаУдаления
	|	И докСертификат.СертификатДействителен
	|	И докСертификат.КонецДействияСертификата <= &ДатаОсвобожденияОтПрививки";
	Результат = Запрос.Выполнить().Выбрать();
	Если Результат.Количество() = 0 Тогда 
		Возврат Неопределено;
	Иначе 
		Результат.Следующий();
		СтруктураВозврата = Новый Структура;
		СтруктураВозврата.Вставить("Ссылка", Результат.Сертификат);
		СтруктураВозврата.Вставить("НачалоДействияСертификата", Результат.НачалоДействияСертификата);
		СтруктураВозврата.Вставить("КонецДействияСертификата", Результат.КонецДействияСертификата);
		СтруктураВозврата.Вставить("СертификатДействителен", Результат.СертификатДействителен);
		Возврат СтруктураВозврата;
	КонецЕсли;
КонецФункции


&НаКлиенте
Процедура СрокОсвобожденияОтПрививкиПриИзменении(Элемент)
	Если ЗначениеЗаполнено(Объект.СрокОсвобожденияОтПрививки) Тогда 
		ПараметрыПоиска = Новый Структура("Сотрудник, ДатаОсвобождения", Объект.Сотрудник, Объект.СрокОсвобожденияОтПрививки);
		Сертификат = СрокОсвобожденияОтПрививкиПриИзмененииНаСервере(ПараметрыПоиска);
		Если ЗначениеЗаполнено(Сертификат) Тогда 
			Объект.НачалоДействияСертификата = Сертификат.НачалоДействияСертификата;
			Объект.КонецДействияСертификата =  Сертификат.КонецДействияСертификата;
			Объект.Сертификат = Сертификат.Ссылка;
		Иначе 
			Объект.Сертификат = Неопределено;
		КонецЕсли;
	Иначе 
		Объект.Сертификат = Неопределено;
	КонецЕсли;
	Если Объект.Сертификат = Неопределено Тогда 
			Объект.НачалоДействияСертификата = Неопределено;
			Объект.КонецДействияСертификата =  Неопределено;
	КонецЕсли;
	
	УправлениеФормой();
КонецПроцедуры



